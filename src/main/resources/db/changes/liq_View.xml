<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

    <changeSet author="namdari" id="1681723197">
        <createView viewName="view_grade" replaceIfExists="true">
            <![CDATA[
          SELECT distinct
                syn_hrm_view_grade.id,
                syn_hrm_view_grade.c_post_grade_code,
                syn_hrm_view_grade.c_post_grade_title,
                tbl_group_grade.group_id
            FROM
                syn_hrm_view_grade
                LEFT JOIN tbl_group_grade ON syn_hrm_view_grade.c_post_grade_code = tbl_group_grade.c_grade_code
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1681810266">
        <createView viewName="view_post" replaceIfExists="true">
            <![CDATA[
                SELECT
                    ROWNUM as id,
                    post.*
                    FROM
                    (
                        SELECT
                            *
                        FROM
                            syn_hrm_post
                    )post
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1681883250">
        <createView viewName="view_group_post" replaceIfExists="true">
            <![CDATA[
                SELECT
                    ROWNUM AS id,
                    groupPost.*
                FROM
                    (
                        SELECT
                            MIN(post_id) post_id,
                            MIN(post_grade_id) post_grade_id,
                            MIN(post_grade_code) post_grade_code,
                            MIN(post_grade_title) post_grade_title,
                            MIN(post_grade_code_parent) post_grade_code_parent,
                            MIN(post_grade_title_parent) post_grade_title_parent,
                            post_group_code group_post_code,
                            MIN(post_title) post_title,
                            MIN(post_parent_id) post_parent_id,
                            MIN(post_level) post_level,
                            MIN(post_full_path_code) post_full_path_code,
                            MIN(post_mosavab) post_mosavab,
                            MIN(post_company_id) post_company_id,
                            MIN(post_company_code) post_company_code,
                            MIN(post_company_name) post_company_name,
                            MIN(cost_center_id) cost_center_id,
                            MIN(cost_center_code) cost_center_code,
                            MIN(cost_center_title) cost_center_title,
                            MIN(hoze_code) hoze_code,
                            MIN(hoze_title) hoze_title,
                            MIN(mojtama_code) mojtama_code,
                            MIN(mojtama_title) mojtama_title,
                            MIN(omoor_code) omoor_code,
                            MIN(omoor_title) omoor_title,
                            MIN(moavenat_code) moavenat_code,
                            MIN(moavenat_title) moavenat_title,
                            MIN(ghesmat_code) ghesmat_code,
                            MIN(ghesmat_title) ghesmat_title,
                            MIN(vahed_code) vahed_code,
                            MIN(vahed_title) vahed_title
                        FROM
                            syn_hrm_post
                        GROUP BY (
                            post_group_code
                        )
                    ) groupPost
            ]]>
        </createView>
    </changeSet>

    <changeSet author="semami" id="1682421852">
        <createView viewName="view_personnel" replaceIfExists="true">
            <![CDATA[
                 select
                    rownum as id,
                    personnel.*
                    from
                    (
                        select
                            *
                        from
                            syn_hrm_personnel
                    )personnel
            ]]>
        </createView>
    </changeSet>

    <changeSet author="semami" id="1682489292">
        <createView viewName="view_person" replaceIfExists="true">
            <![CDATA[
                  select
                    rownum as id,
                    person.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_PERSON
                    )person
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681727593">
        <createView viewName="view_grade" replaceIfExists="true">
            <![CDATA[
          SELECT distinct
                syn_hrm_view_grade.id,
                syn_hrm_view_grade.c_post_grade_code,
                syn_hrm_view_grade.c_post_grade_title,
                tbl_group_grade.group_id
            FROM
                syn_hrm_view_grade
                LEFT JOIN tbl_group_grade ON syn_hrm_view_grade.c_post_grade_code = tbl_group_grade.c_grade_code
            WHERE
                syn_hrm_view_grade.c_post_grade_code is not null
            ]]>
        </createView>
    </changeSet>

    <changeSet author="a.lotfi" id="1683543237">
        <createView viewName="view_organization" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    org.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_COMPANY_STRUCTURE
                    )org
            ]]>
        </createView>
    </changeSet>

    <changeSet author="a.lotfi" id="1683702311">
        <createView viewName="view_organization_tree" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    orgTree.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_CHART_POST_TREE
                    )orgTree
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681832567">
        <createView viewName="view_personnel" replaceIfExists="true">
            <![CDATA[
                 select
                    rownum as id,
                    personnel.*
                    from
                    (
                        select
                            *
                        from
                            syn_hrm_personnel
                    )personnel
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681832415">
        <createView viewName="view_person" replaceIfExists="true">
            <![CDATA[
                  select
                    rownum as id,
                    person.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_PERSON
                    )person
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1682156219">
        <createView viewName="view_organization_tree" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    orgTree.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_CHART_POST_TREE
                    )orgTree
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1682157107">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    postRelation.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_POST_RELATION
                    ) postRelation
            ]]>
        </createView>
    </changeSet>
    <changeSet author="namdari" id="1681883251">
        <createView viewName="view_group_post" replaceIfExists="true">
            <![CDATA[
           SELECT
                    ROWNUM AS id,
                    groupPost."POST_ID",groupPost."POST_GRADE_ID",groupPost."POST_GRADE_CODE",groupPost."POST_GRADE_TITLE",groupPost."POST_GRADE_CODE_PARENT",groupPost."POST_GRADE_TITLE_PARENT",groupPost."GROUP_POST_CODE",groupPost."POST_TITLE",groupPost."POST_PARENT_ID",groupPost."POST_LEVEL",groupPost."POST_FULL_PATH_CODE",groupPost."POST_MOSAVAB",groupPost."POST_COMPANY_ID",groupPost."POST_COMPANY_CODE",groupPost."POST_COMPANY_NAME",groupPost."COST_CENTER_ID",groupPost."COST_CENTER_CODE",groupPost."COST_CENTER_TITLE",groupPost."HOZE_CODE",groupPost."HOZE_TITLE",groupPost."MOJTAMA_CODE",groupPost."MOJTAMA_TITLE",groupPost."OMOOR_CODE",groupPost."OMOOR_TITLE",groupPost."MOAVENAT_CODE",groupPost."MOAVENAT_TITLE",groupPost."GHESMAT_CODE",groupPost."GHESMAT_TITLE",groupPost."VAHED_CODE",groupPost."VAHED_TITLE"
                FROM
                    (
                        SELECT   DISTINCT
                            MIN(post_id) OVER (PARTITION BY post_group_code)  as post_id,
                            MIN(post_grade_id) OVER (PARTITION BY post_group_code)  as  post_grade_id,
                            MIN(post_grade_code) OVER (PARTITION BY post_group_code)  as  post_grade_code,
                            MIN(post_grade_title) OVER (PARTITION BY post_group_code)  as  post_grade_title,
                            MIN(post_grade_code_parent) OVER (PARTITION BY post_group_code)  as  post_grade_code_parent,
                            MIN(post_grade_title_parent) OVER (PARTITION BY post_group_code)  as  post_grade_title_parent,
                            post_group_code group_post_code,
                            MIN(post_title) OVER (PARTITION BY post_group_code)  as  post_title,
                            MIN(post_parent_id) OVER (PARTITION BY post_group_code)  as  post_parent_id,
                            MIN(post_level) OVER (PARTITION BY post_group_code)  as  post_level,
                            MIN(post_full_path_code) OVER (PARTITION BY post_group_code)  as  post_full_path_code,
                            MIN(post_mosavab) OVER (PARTITION BY post_group_code)  as  post_mosavab,
                            MIN(post_company_id) OVER (PARTITION BY post_group_code)  as  post_company_id,
                            MIN(post_company_code) OVER (PARTITION BY post_group_code)  as  post_company_code,
                            MIN(post_company_name) OVER (PARTITION BY post_group_code)  as  post_company_name,
                            MIN(cost_center_id) OVER (PARTITION BY post_group_code)  as  cost_center_id,
                            MIN(cost_center_code) OVER (PARTITION BY post_group_code)  as  cost_center_code,
                            MIN(cost_center_title) OVER (PARTITION BY post_group_code)  as  cost_center_title,
                            MIN(hoze_code) OVER (PARTITION BY post_group_code)  as  hoze_code,
                            MIN(hoze_title) OVER (PARTITION BY post_group_code)  as  hoze_title,
                            MIN(mojtama_code) OVER (PARTITION BY post_group_code)  as  mojtama_code,
                            MIN(mojtama_title) OVER (PARTITION BY post_group_code)  as  mojtama_title,
                            MIN(omoor_code) OVER (PARTITION BY post_group_code)  as  omoor_code,
                            MIN(omoor_title) OVER (PARTITION BY post_group_code)  as  omoor_title,
                            MIN(moavenat_code) OVER (PARTITION BY post_group_code)  as  moavenat_code,
                            MIN(moavenat_title) OVER (PARTITION BY post_group_code)  as  moavenat_title,
                            MIN(ghesmat_code) OVER (PARTITION BY post_group_code)  as  ghesmat_code,
                            MIN(ghesmat_title) OVER (PARTITION BY post_group_code)  as  ghesmat_title,
                            MIN(vahed_code) OVER (PARTITION BY post_group_code)  as  vahed_code,
                            MIN(vahed_title) OVER (PARTITION BY post_group_code)  as  vahed_title
                        FROM
                            syn_hrm_post

                    ) groupPost
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681927432">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    postRelation.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_POST_RELATION
                    ) postRelation
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1687764344">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
               SELECT
                    ROWNUM AS id,
                    postrelation.*
                FROM
                    (
                        SELECT
                            relation.*,
                           postMerit.id POST_MERIT_ID
                        FROM
                            syn_hrm_post_relation relation
                            left join tbl_post_merit_component postMerit on postmerit.C_GROUP_POST_CODE = relation.post_group_code

                    ) postrelation
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1687856234">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
                SELECT
                    ROWNUM AS id,
                    postrelation.*
                FROM
                    (
                        SELECT DISTINCT
                            relation.*,
                            LISTAGG(postmerit.id, ', ') WITHIN GROUP(
                                ORDER BY
                                    postmerit.id
                            ) OVER(
                                PARTITION BY post_code
                            ) post_merit_id
                        FROM
                            syn_hrm_post_relation      relation
                            LEFT JOIN tbl_post_merit_component   postmerit ON postmerit.c_group_post_code = relation.post_group_code
                    ) postrelation
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681795066">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
                SELECT
                    ROWNUM AS id,
                    postrelation.*
                FROM
                    (
                        SELECT DISTINCT
                            relation.*,
                            LISTAGG(postmerit.id, ', ') WITHIN GROUP(
                                ORDER BY
                                    postmerit.id
                            ) OVER(
                                PARTITION BY post_code
                            ) post_merit_id
                        FROM
                            syn_hrm_post_relation      relation
                            LEFT JOIN tbl_post_merit_component   postmerit ON postmerit.c_group_post_code = relation.post_group_code
                    ) postrelation
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681727591">
        <createView viewName="view_organization_tree" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    orgTree.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_CHART_POST_TREE
                    )orgTree
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681727637">
        <createView viewName="view_person" replaceIfExists="true">
            <![CDATA[
                    SELECT
                        ROWNUM AS id,
                        person.*
                    FROM
                        (
                            SELECT
                                person_id,
                                personel_id,
                                first_name,
                                last_name,
                                national_code,
                                father_name,
                                mother_name,
                                to_char(
                                    birth_date, 'yyyy/mm/dd', 'nls_calendar=persian'
                                ) AS birth_date,
                                gender_id,
                                gender_name,
                                mobile_number,
                                email,
                                birth_certificate_number,
                                birth_certificate_series,
                                birth_certificate_serial,
                                area_city_id,
                                area_city_name,
                                birth_area_city_id,
                                birth_area_city_name,
                                nationality_id,
                                nationality_name,
                                religion_id,
                                religion_name,
                                tahol_status_id,
                                tahol_status_name,
                                military_id,
                                military_name,
                                blood_typen_id,
                                blood_typen_name,
                                to_char(
                                    death_date, 'yyyy/mm/dd', 'nls_calendar=persian'
                                ) AS death_date,
                                death_cause_id,
                                death_description,
                                post_code,
                                post_title
                            FROM
                                syn_hrm_person
                        ) person
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1696074824">
        <dropView ifExists="true" viewName="view_post"/>
    </changeSet>

    <changeSet author="MShahabi" id="1696074832">
        <sql>
            CREATE MATERIALIZED VIEW view_post AS
            SELECT
                ROWNUM AS id,
                post.*
            FROM
                (
                    SELECT
                        *
                    FROM
                        syn_hrm_post
                ) post
        </sql>
    </changeSet>

</databaseChangeLog>