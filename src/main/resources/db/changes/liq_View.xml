<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

    <changeSet author="namdari" id="1681723197">
        <createView viewName="view_grade" replaceIfExists="true">
            <![CDATA[
          SELECT distinct
                syn_hrm_view_grade.id,
                syn_hrm_view_grade.c_post_grade_code,
                syn_hrm_view_grade.c_post_grade_title,
                tbl_group_grade.group_id
            FROM
                syn_hrm_view_grade
                LEFT JOIN tbl_group_grade ON syn_hrm_view_grade.c_post_grade_code = tbl_group_grade.c_grade_code
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1681810266">
        <createView viewName="view_post" replaceIfExists="true">
            <![CDATA[
                SELECT
                    ROWNUM as id,
                    post.*
                    FROM
                    (
                        SELECT
                            *
                        FROM
                            syn_hrm_post
                    )post
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1681883250">
        <createView viewName="view_group_post" replaceIfExists="true">
            <![CDATA[
                SELECT
                    ROWNUM AS id,
                    groupPost.*
                FROM
                    (
                        SELECT
                            MIN(post_id) post_id,
                            MIN(post_grade_id) post_grade_id,
                            MIN(post_grade_code) post_grade_code,
                            MIN(post_grade_title) post_grade_title,
                            MIN(post_grade_code_parent) post_grade_code_parent,
                            MIN(post_grade_title_parent) post_grade_title_parent,
                            post_group_code group_post_code,
                            MIN(post_title) post_title,
                            MIN(post_parent_id) post_parent_id,
                            MIN(post_level) post_level,
                            MIN(post_full_path_code) post_full_path_code,
                            MIN(post_mosavab) post_mosavab,
                            MIN(post_company_id) post_company_id,
                            MIN(post_company_code) post_company_code,
                            MIN(post_company_name) post_company_name,
                            MIN(cost_center_id) cost_center_id,
                            MIN(cost_center_code) cost_center_code,
                            MIN(cost_center_title) cost_center_title,
                            MIN(hoze_code) hoze_code,
                            MIN(hoze_title) hoze_title,
                            MIN(mojtama_code) mojtama_code,
                            MIN(mojtama_title) mojtama_title,
                            MIN(omoor_code) omoor_code,
                            MIN(omoor_title) omoor_title,
                            MIN(moavenat_code) moavenat_code,
                            MIN(moavenat_title) moavenat_title,
                            MIN(ghesmat_code) ghesmat_code,
                            MIN(ghesmat_title) ghesmat_title,
                            MIN(vahed_code) vahed_code,
                            MIN(vahed_title) vahed_title
                        FROM
                            syn_hrm_post
                        GROUP BY (
                            post_group_code
                        )
                    ) groupPost
            ]]>
        </createView>
    </changeSet>

    <changeSet author="semami" id="1682421852">
        <createView viewName="view_personnel" replaceIfExists="true">
            <![CDATA[
                 select
                    rownum as id,
                    personnel.*
                    from
                    (
                        select
                            *
                        from
                            syn_hrm_personnel
                    )personnel
            ]]>
        </createView>
    </changeSet>

    <changeSet author="semami" id="1682489292">
        <createView viewName="view_person" replaceIfExists="true">
            <![CDATA[
                  select
                    rownum as id,
                    person.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_PERSON
                    )person
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681727593">
        <createView viewName="view_grade" replaceIfExists="true">
            <![CDATA[
          SELECT distinct
                syn_hrm_view_grade.id,
                syn_hrm_view_grade.c_post_grade_code,
                syn_hrm_view_grade.c_post_grade_title,
                tbl_group_grade.group_id
            FROM
                syn_hrm_view_grade
                LEFT JOIN tbl_group_grade ON syn_hrm_view_grade.c_post_grade_code = tbl_group_grade.c_grade_code
            WHERE
                syn_hrm_view_grade.c_post_grade_code is not null
            ]]>
        </createView>
    </changeSet>

    <changeSet author="a.lotfi" id="1683543237">
        <createView viewName="view_organization" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    org.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_COMPANY_STRUCTURE
                    )org
            ]]>
        </createView>
    </changeSet>

    <changeSet author="a.lotfi" id="1683702311">
        <createView viewName="view_organization_tree" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    orgTree.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_CHART_POST_TREE
                    )orgTree
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681832567">
        <createView viewName="view_personnel" replaceIfExists="true">
            <![CDATA[
                 select
                    rownum as id,
                    personnel.*
                    from
                    (
                        select
                            *
                        from
                            syn_hrm_personnel
                    )personnel
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681832415">
        <createView viewName="view_person" replaceIfExists="true">
            <![CDATA[
                  select
                    rownum as id,
                    person.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_PERSON
                    )person
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1682156219">
        <createView viewName="view_organization_tree" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    orgTree.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_CHART_POST_TREE
                    )orgTree
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1682157107">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    postRelation.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_POST_RELATION
                    ) postRelation
            ]]>
        </createView>
    </changeSet>
    <changeSet author="namdari" id="1681883251">
        <createView viewName="view_group_post" replaceIfExists="true">
            <![CDATA[
           SELECT
                    ROWNUM AS id,
                    groupPost."POST_ID",groupPost."POST_GRADE_ID",groupPost."POST_GRADE_CODE",groupPost."POST_GRADE_TITLE",groupPost."POST_GRADE_CODE_PARENT",groupPost."POST_GRADE_TITLE_PARENT",groupPost."GROUP_POST_CODE",groupPost."POST_TITLE",groupPost."POST_PARENT_ID",groupPost."POST_LEVEL",groupPost."POST_FULL_PATH_CODE",groupPost."POST_MOSAVAB",groupPost."POST_COMPANY_ID",groupPost."POST_COMPANY_CODE",groupPost."POST_COMPANY_NAME",groupPost."COST_CENTER_ID",groupPost."COST_CENTER_CODE",groupPost."COST_CENTER_TITLE",groupPost."HOZE_CODE",groupPost."HOZE_TITLE",groupPost."MOJTAMA_CODE",groupPost."MOJTAMA_TITLE",groupPost."OMOOR_CODE",groupPost."OMOOR_TITLE",groupPost."MOAVENAT_CODE",groupPost."MOAVENAT_TITLE",groupPost."GHESMAT_CODE",groupPost."GHESMAT_TITLE",groupPost."VAHED_CODE",groupPost."VAHED_TITLE"
                FROM
                    (
                        SELECT   DISTINCT
                            MIN(post_id) OVER (PARTITION BY post_group_code)  as post_id,
                            MIN(post_grade_id) OVER (PARTITION BY post_group_code)  as  post_grade_id,
                            MIN(post_grade_code) OVER (PARTITION BY post_group_code)  as  post_grade_code,
                            MIN(post_grade_title) OVER (PARTITION BY post_group_code)  as  post_grade_title,
                            MIN(post_grade_code_parent) OVER (PARTITION BY post_group_code)  as  post_grade_code_parent,
                            MIN(post_grade_title_parent) OVER (PARTITION BY post_group_code)  as  post_grade_title_parent,
                            post_group_code group_post_code,
                            MIN(post_title) OVER (PARTITION BY post_group_code)  as  post_title,
                            MIN(post_parent_id) OVER (PARTITION BY post_group_code)  as  post_parent_id,
                            MIN(post_level) OVER (PARTITION BY post_group_code)  as  post_level,
                            MIN(post_full_path_code) OVER (PARTITION BY post_group_code)  as  post_full_path_code,
                            MIN(post_mosavab) OVER (PARTITION BY post_group_code)  as  post_mosavab,
                            MIN(post_company_id) OVER (PARTITION BY post_group_code)  as  post_company_id,
                            MIN(post_company_code) OVER (PARTITION BY post_group_code)  as  post_company_code,
                            MIN(post_company_name) OVER (PARTITION BY post_group_code)  as  post_company_name,
                            MIN(cost_center_id) OVER (PARTITION BY post_group_code)  as  cost_center_id,
                            MIN(cost_center_code) OVER (PARTITION BY post_group_code)  as  cost_center_code,
                            MIN(cost_center_title) OVER (PARTITION BY post_group_code)  as  cost_center_title,
                            MIN(hoze_code) OVER (PARTITION BY post_group_code)  as  hoze_code,
                            MIN(hoze_title) OVER (PARTITION BY post_group_code)  as  hoze_title,
                            MIN(mojtama_code) OVER (PARTITION BY post_group_code)  as  mojtama_code,
                            MIN(mojtama_title) OVER (PARTITION BY post_group_code)  as  mojtama_title,
                            MIN(omoor_code) OVER (PARTITION BY post_group_code)  as  omoor_code,
                            MIN(omoor_title) OVER (PARTITION BY post_group_code)  as  omoor_title,
                            MIN(moavenat_code) OVER (PARTITION BY post_group_code)  as  moavenat_code,
                            MIN(moavenat_title) OVER (PARTITION BY post_group_code)  as  moavenat_title,
                            MIN(ghesmat_code) OVER (PARTITION BY post_group_code)  as  ghesmat_code,
                            MIN(ghesmat_title) OVER (PARTITION BY post_group_code)  as  ghesmat_title,
                            MIN(vahed_code) OVER (PARTITION BY post_group_code)  as  vahed_code,
                            MIN(vahed_title) OVER (PARTITION BY post_group_code)  as  vahed_title
                        FROM
                            syn_hrm_post

                    ) groupPost
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681927432">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    postRelation.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_POST_RELATION
                    ) postRelation
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1687764344">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
               SELECT
                    ROWNUM AS id,
                    postrelation.*
                FROM
                    (
                        SELECT
                            relation.*,
                           postMerit.id POST_MERIT_ID
                        FROM
                            syn_hrm_post_relation relation
                            left join tbl_post_merit_component postMerit on postmerit.C_GROUP_POST_CODE = relation.post_group_code

                    ) postrelation
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1687856234">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
                SELECT
                    ROWNUM AS id,
                    postrelation.*
                FROM
                    (
                        SELECT DISTINCT
                            relation.*,
                            LISTAGG(postmerit.id, ', ') WITHIN GROUP(
                                ORDER BY
                                    postmerit.id
                            ) OVER(
                                PARTITION BY post_code
                            ) post_merit_id
                        FROM
                            syn_hrm_post_relation      relation
                            LEFT JOIN tbl_post_merit_component   postmerit ON postmerit.c_group_post_code = relation.post_group_code
                    ) postrelation
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681795066">
        <createView viewName="view_post_relation" replaceIfExists="true">
            <![CDATA[
                SELECT
                    ROWNUM AS id,
                    postrelation.*
                FROM
                    (
                        SELECT DISTINCT
                            relation.*,
                            LISTAGG(postmerit.id, ', ') WITHIN GROUP(
                                ORDER BY
                                    postmerit.id
                            ) OVER(
                                PARTITION BY post_code
                            ) post_merit_id
                        FROM
                            syn_hrm_post_relation      relation
                            LEFT JOIN tbl_post_merit_component   postmerit ON postmerit.c_group_post_code = relation.post_group_code
                    ) postrelation
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681727591">
        <createView viewName="view_organization_tree" replaceIfExists="true">
            <![CDATA[
                select
                    rownum as id,
                    orgTree.*
                    from
                    (
                        select
                            *
                        from
                            SYN_HRM_CHART_POST_TREE
                    )orgTree
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1681727637">
        <createView viewName="view_person" replaceIfExists="true">
            <![CDATA[
                    SELECT
                        ROWNUM AS id,
                        person.*
                    FROM
                        (
                            SELECT
                                person_id,
                                personel_id,
                                first_name,
                                last_name,
                                national_code,
                                father_name,
                                mother_name,
                                to_char(
                                    birth_date, 'yyyy/mm/dd', 'nls_calendar=persian'
                                ) AS birth_date,
                                gender_id,
                                gender_name,
                                mobile_number,
                                email,
                                birth_certificate_number,
                                birth_certificate_series,
                                birth_certificate_serial,
                                area_city_id,
                                area_city_name,
                                birth_area_city_id,
                                birth_area_city_name,
                                nationality_id,
                                nationality_name,
                                religion_id,
                                religion_name,
                                tahol_status_id,
                                tahol_status_name,
                                military_id,
                                military_name,
                                blood_typen_id,
                                blood_typen_name,
                                to_char(
                                    death_date, 'yyyy/mm/dd', 'nls_calendar=persian'
                                ) AS death_date,
                                death_cause_id,
                                death_description,
                                post_code,
                                post_title
                            FROM
                                syn_hrm_person
                        ) person
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1696074824">
        <dropView ifExists="true" viewName="view_post"/>
    </changeSet>

    <changeSet author="MShahabi" id="1696074832">
        <sql>
            CREATE MATERIALIZED VIEW view_post AS
            SELECT
                ROWNUM AS id,
                post.*
            FROM
                (
                    SELECT
                        *
                    FROM
                        syn_hrm_post
                ) post
        </sql>
    </changeSet>
    <changeSet author="semami" id="1698735070">
        <createView viewName="view_evaluation" replaceIfExists="true">
            <![CDATA[
                    SELECT
                        evaluation.id,
                        evaluation.c_assess_national_code,
                        evaluation.c_assess_post_code,
                        evaluation.c_assessor_national_code,
                        evaluation.c_assessor_post_code,
                        evaluation.method_catalog_id,
                        evaluation.evaluation_period_id,
                        evaluation.average_score,
                        evaluation.c_assessor_full_name,
                        evaluation.c_assess_full_name,
                        evaluation.special_case_id,
                        evaluation.c_description,
                        evaluation.status_catalog_id,
                        evaluation.c_created_by,
                        evaluation.d_created_date,
                        evaluation.c_last_modified_by,
                        evaluation.d_last_modified_date,
                        evaluation.n_version,
                        post.ghesmat_title,
                        post.hoze_title,
                        post.moavenat_title,
                        post.mojtama_title,
                        post.omoor_title,
                        post.post_code,
                        post.post_grade_code,
                        post.post_grade_title,
                        post.post_group_code,
                        post.post_id,
                        post.post_title,
                        post.vahed_title
                    FROM
                        tbl_evaluation evaluation
                        join view_post post on post.post_code = evaluation.c_assess_post_code
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1698735071">
        <createView viewName="view_evaluation" replaceIfExists="true">
            <![CDATA[
                    SELECT
                        evaluation.id,
                        evaluation.c_assess_national_code,
                        evaluation.c_assess_post_code,
                        evaluation.c_assessor_national_code,
                        evaluation.c_assessor_post_code,
                        evaluation.method_catalog_id,
                        evaluation.evaluation_period_id,
                        evaluation.average_score,
                        evaluation.c_assessor_full_name,
                        evaluation.c_assess_full_name,
                        evaluation.special_case_id,
                        evaluation.c_description,
                        evaluation.status_catalog_id,
                        evaluation.c_created_by,
                        evaluation.d_created_date,
                        evaluation.c_last_modified_by,
                        evaluation.d_last_modified_date,
                        evaluation.n_version,
                        post.ghesmat_title,
                        post.hoze_title,
                        post.moavenat_title,
                        post.mojtama_title,
                        post.omoor_title,
                        post.post_code,
                        post.post_grade_code,
                        post.post_grade_title,
                        post.post_group_code,
                        post.post_id,
                        post.post_title,
                        post.vahed_title,
                        post1.post_title as assessor_post_title
                    FROM
                        tbl_evaluation evaluation
                        join view_post post on post.post_code = evaluation.c_assess_post_code
                        join view_post post1 on post1.post_code = evaluation.c_assessor_post_code
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1699254278">
        <createView viewName="view_department" replaceIfExists="true">
            <![CDATA[
                  select
                    rownum as id,
                    department.*
                    from
                    (
                        select
                            *
                        from
                            HRM_TBL_DEPARTMENT
                    ) department
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1699260268">
        <createView viewName="view_person" replaceIfExists="true">
            <![CDATA[
                    SELECT
                        ROWNUM AS id,
                        person.*
                    FROM
                        (
                            SELECT
                                person_id,
                                personel_id,
                                personnel_code,
                                first_name,
                                last_name,
                                national_code,
                                father_name,
                                mother_name,
                                to_char(
                                    birth_date, 'yyyy/mm/dd', 'nls_calendar=persian'
                                ) AS birth_date,
                                gender_id,
                                gender_name,
                                mobile_number,
                                email,
                                birth_certificate_number,
                                birth_certificate_series,
                                birth_certificate_serial,
                                area_city_id,
                                area_city_name,
                                birth_area_city_id,
                                birth_area_city_name,
                                nationality_id,
                                nationality_name,
                                religion_id,
                                religion_name,
                                tahol_status_id,
                                tahol_status_name,
                                military_id,
                                military_name,
                                blood_typen_id,
                                blood_typen_name,
                                to_char(
                                    death_date, 'yyyy/mm/dd', 'nls_calendar=persian'
                                ) AS death_date,
                                death_cause_id,
                                death_description,
                                post_code,
                                post_title
                            FROM
                                syn_hrm_person
                        ) person
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1699337783">
        <dropView ifExists="true" viewName="view_group_post"/>
    </changeSet>

    <changeSet author="MShahabi" id="1699337790">
        <sql>
            CREATE MATERIALIZED VIEW view_group_post AS
            SELECT
                ROWNUM AS id,
                grouppost."POST_ID",
                grouppost."POST_GRADE_ID",
                grouppost."POST_GRADE_CODE",
                grouppost."POST_GRADE_TITLE",
                grouppost."POST_GRADE_CODE_PARENT",
                grouppost."POST_GRADE_TITLE_PARENT",
                grouppost."GROUP_POST_CODE",
                grouppost."POST_TITLE",
                grouppost."POST_PARENT_ID",
                grouppost."POST_LEVEL",
                grouppost."POST_FULL_PATH_CODE",
                grouppost."POST_MOSAVAB",
                grouppost."POST_COMPANY_ID",
                grouppost."POST_COMPANY_CODE",
                grouppost."POST_COMPANY_NAME",
                grouppost."COST_CENTER_ID",
                grouppost."COST_CENTER_CODE",
                grouppost."COST_CENTER_TITLE",
                grouppost."HOZE_CODE",
                grouppost."HOZE_TITLE",
                grouppost."MOJTAMA_CODE",
                grouppost."MOJTAMA_TITLE",
                grouppost."OMOOR_CODE",
                grouppost."OMOOR_TITLE",
                grouppost."MOAVENAT_CODE",
                grouppost."MOAVENAT_TITLE",
                grouppost."GHESMAT_CODE",
                grouppost."GHESMAT_TITLE",
                grouppost."VAHED_CODE",
                grouppost."VAHED_TITLE"
            FROM
                (
                    SELECT DISTINCT
                        MIN(post_id)
                            OVER(PARTITION BY post_group_code) AS post_id,
                            MIN(post_grade_id)
                                OVER(PARTITION BY post_group_code) AS post_grade_id,
                            MIN(post_grade_code)
                                OVER(PARTITION BY post_group_code) AS post_grade_code,
                            MIN(post_grade_title)
                                OVER(PARTITION BY post_group_code) AS post_grade_title,
                            MIN(post_grade_code_parent)
                                OVER(PARTITION BY post_group_code) AS post_grade_code_parent,
                            MIN(post_grade_title_parent)
                                OVER(PARTITION BY post_group_code) AS post_grade_title_parent,
                            post_group_code                    group_post_code,
                        MIN(post_title)
                            OVER(PARTITION BY post_group_code) AS post_title,
                            MIN(post_parent_id)
                                OVER(PARTITION BY post_group_code) AS post_parent_id,
                            MIN(post_level)
                                OVER(PARTITION BY post_group_code) AS post_level,
                            MIN(post_full_path_code)
                                OVER(PARTITION BY post_group_code) AS post_full_path_code,
                            MIN(post_mosavab)
                                OVER(PARTITION BY post_group_code) AS post_mosavab,
                            MIN(post_company_id)
                                OVER(PARTITION BY post_group_code) AS post_company_id,
                            MIN(post_company_code)
                                OVER(PARTITION BY post_group_code) AS post_company_code,
                            MIN(post_company_name)
                                OVER(PARTITION BY post_group_code) AS post_company_name,
                            MIN(cost_center_id)
                                OVER(PARTITION BY post_group_code) AS cost_center_id,
                            MIN(cost_center_code)
                                OVER(PARTITION BY post_group_code) AS cost_center_code,
                            MIN(cost_center_title)
                                OVER(PARTITION BY post_group_code) AS cost_center_title,
                            MIN(hoze_code)
                                OVER(PARTITION BY post_group_code) AS hoze_code,
                            MIN(hoze_title)
                                OVER(PARTITION BY post_group_code) AS hoze_title,
                            MIN(mojtama_code)
                                OVER(PARTITION BY post_group_code) AS mojtama_code,
                            MIN(mojtama_title)
                                OVER(PARTITION BY post_group_code) AS mojtama_title,
                            MIN(omoor_code)
                                OVER(PARTITION BY post_group_code) AS omoor_code,
                            MIN(omoor_title)
                                OVER(PARTITION BY post_group_code) AS omoor_title,
                            MIN(moavenat_code)
                                OVER(PARTITION BY post_group_code) AS moavenat_code,
                            MIN(moavenat_title)
                                OVER(PARTITION BY post_group_code) AS moavenat_title,
                            MIN(ghesmat_code)
                                OVER(PARTITION BY post_group_code) AS ghesmat_code,
                            MIN(ghesmat_title)
                                OVER(PARTITION BY post_group_code) AS ghesmat_title,
                            MIN(vahed_code)
                                OVER(PARTITION BY post_group_code) AS vahed_code,
                            MIN(vahed_title)
                                OVER(PARTITION BY post_group_code) AS vahed_title
                    FROM
                        syn_hrm_post
                ) grouppost
        </sql>
    </changeSet>

    <changeSet author="MShahabi" id="1699354106">
        <createView viewName="view_sensitive_event_person" replaceIfExists="true">
            <![CDATA[
                    SELECT
                        se.id              AS id,
                        se.c_title,
                        se.d_event_date,
                        se.d_to_date,
                        se.n_level_effect,
                        se.type_catalog_id,
                        se.event_policy_catalog_id,
                        se.status_catalog_id,
                        se.c_description,
                        se.c_national_code AS creator_national_code,
                        sep.id             AS sensitive_event_person_id,
                        sep.c_national_code,
                        per.first_name,
                        per.last_name,
                        per.personnel_code
                    FROM
                        tbl_sensitive_events       se
                        LEFT JOIN tbl_sensitive_event_person sep ON se.id = sep.sensitive_event_id
                        LEFT JOIN view_person                per ON per.national_code = sep.c_national_code
            ]]>
        </createView>
    </changeSet>

    <changeSet author="MShahabi" id="1699688813">
        <createView viewName="view_sensitive_event_person" replaceIfExists="true">
            <![CDATA[
                    SELECT
                        ROWNUM AS id,
                        sensitiveEventPerson.*
                    FROM
                        (
                            SELECT
                                se.id              AS sensitive_event_id,
                                se.c_title,
                                se.d_event_date,
                                se.d_to_date,
                                se.n_level_effect,
                                se.type_catalog_id,
                                se.event_policy_catalog_id,
                                se.status_catalog_id,
                                se.c_description,
                                se.c_national_code AS creator_national_code,
                                sep.id             AS sensitive_event_person_id,
                                sep.c_national_code,
                                per.first_name,
                                per.last_name,
                                per.personnel_code
                            FROM
                                tbl_sensitive_events       se
                                LEFT JOIN tbl_sensitive_event_person sep ON se.id = sep.sensitive_event_id
                                LEFT JOIN view_person                per ON per.national_code = sep.c_national_code
                        ) sensitiveEventPerson
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1700292111">
        <createView viewName="view_evaluation" replaceIfExists="true">
            <![CDATA[
                    SELECT
                        evaluation.id,
                        evaluation.c_assess_national_code,
                        evaluation.c_assess_post_code,
                        evaluation.c_assessor_national_code,
                        evaluation.c_assessor_post_code,
                        evaluation.method_catalog_id,
                        evaluation.evaluation_period_id,
                        evaluation.average_score,
                        evaluation.c_assessor_full_name,
                        evaluation.c_assess_full_name,
                        evaluation.special_case_id,
                        evaluation.c_description,
                        evaluation.status_catalog_id,
                        evaluation.c_created_by,
                        evaluation.d_created_date,
                        evaluation.c_last_modified_by,
                        evaluation.d_last_modified_date,
                        evaluation.n_version,
                        post.ghesmat_title,
                        post.hoze_title,
                        post.moavenat_title,
                        post.mojtama_title,
                        post.omoor_title,
                        post.post_code,
                        post.post_grade_code,
                        post.post_grade_title,
                        post.post_group_code,
                        post.post_id,
                        post.post_title,
                        post.vahed_title,
                        post.cost_center_code ,
                        post.cost_center_title ,
                        post1.cost_center_code as assessor_cost_center_code,
                        post1.cost_center_title as assessor_cost_center_title,
                        post1.post_title as assessor_post_title,
                        person.personnel_code personnel_code
                    FROM
                        tbl_evaluation evaluation
                        join view_post post on post.post_code = evaluation.c_assess_post_code
                        join view_post post1 on post1.post_code = evaluation.c_assessor_post_code
                        join view_person person on person.national_code = evaluation.c_assess_national_code
            ]]>
        </createView>
    </changeSet>
    <changeSet author="semami" id="1700395657">
        <createView viewName="view_evaluation_general_report" replaceIfExists="true">
            <![CDATA[
                    WITH
                    behavioral_development_avg AS (
                        SELECT
                            SUM(evalItem.questionnaire_answer_catalog_value) AS avg_value,
                            MAX(groupType.n_weight) weight,
                            evalItem.evaluation_id   AS evaluation_id,
                            kpiType.c_title          AS title
                        FROM
                            tbl_group_type_merit   groupTypeMerit
                            JOIN tbl_evaluation_item    evalItem ON evalItem.group_type_merit_id = groupTypeMerit.id
                            JOIN tbl_group_type         groupType ON groupType.id = groupTypeMerit.group_type_id
                            JOIN tbl_kpi_type           kpiType ON kpiType.id = groupType.kpi_type_id
                        GROUP BY
                            evalItem.evaluation_id,
                            kpiType.c_title
                    ),
                    operational_avg AS (
                        SELECT DISTINCT
                            groupType.n_weight       weight,
                            SUM(evalItem.questionnaire_answer_catalog_value) AS avg_value,
                            evalItem.evaluation_id   AS evaluation_id,
                            post.post_code,
                            kpiType.c_title          AS title
                        FROM
                            tbl_post_merit_component   postMerit
                            JOIN tbl_evaluation_item        evalItem ON evalItem.post_merit_id = postMerit.id
                            JOIN tbl_merit_component_type   meritType ON meritType.merit_component_id = postMerit.merit_component_id
                            JOIN tbl_group_type             groupType ON groupType.kpi_type_id = meritType.kpi_type_id
                            JOIN tbl_group                  group1 ON group1.id = groupType.group_id
                            JOIN tbl_group_grade            groupGrade ON groupGrade.group_id = group1.id
                            JOIN view_grade                 grade ON grade.id = groupGrade.grade_id
                            JOIN view_post                  post ON post.post_grade_code = grade.c_post_grade_code
                            JOIN tbl_kpi_type               kpiType ON kpiType.id = meritType.kpi_type_id
                        GROUP BY
                            evalItem.evaluation_id,
                            groupType.n_weight,
                            post.post_code,
                            kpiType.c_title
                    ),
                    evaluationItemCount AS (
                        SELECT
                            evaluation_id,
                            COUNT(*) AS countItem
                        FROM
                            tbl_evaluation_item
                        GROUP BY
                            evaluation_id
                    )
                    SELECT
                        evaluation.id,
                        evaluation.c_assess_national_code,
                        evaluation.c_assess_post_code,
                        evaluation.c_assessor_national_code,
                        evaluation.c_assessor_post_code,
                        evaluation.evaluation_period_id,
                        evaluation.average_score,
                        evaluation.c_assessor_full_name,
                        evaluation.c_assess_full_name,
                        evaluation.status_catalog_id,
                        evaluation.ghesmat_title,
                        evaluation.moavenat_title,
                        evaluation.mojtama_title,
                        evaluation.omoor_title,
                        evaluation.post_title   AS assessor_post_title,
                        behavioral.avg_value            AS avg_behavioral,
                        behavioral.weight               AS weight_behavioral,
                        development.avg_value            AS avg_development,
                        development.weight               AS weight_development,
                        operational.avg_value            AS avg_operational,
                        operational.weight               AS weight_operational,
                        items.countItem
                    FROM
                        view_evaluation evaluation
                        JOIN (
                            SELECT
                                evaluation_id,
                                avg_value,
                                weight,
                                title
                            FROM
                                behavioral_development_avg
                        ) behavioral ON evaluation.id = behavioral.evaluation_id
                                AND behavioral.title = 'رفتاری'
                        JOIN (
                            SELECT
                                evaluation_id,
                                avg_value,
                                weight,
                                title
                            FROM
                                behavioral_development_avg
                        ) development ON evaluation.id = development.evaluation_id
                                AND development.title = 'توسعه شایستگی ها'
                        JOIN (
                            SELECT
                                evaluation_id,
                                avg_value,
                                weight,
                                post_code,
                                title
                            FROM
                                operational_avg
                        ) operational ON   evaluation.id = operational.evaluation_id
                         AND operational.title ='نتیجه ای'
                         JOIN (
                                SELECT
                                    evaluation_id,
                                    countItem
                                FROM
                                    evaluationItemCount
                            ) items ON items.evaluation_id = evaluation.id
                    GROUP BY
                        evaluation.id,
                        evaluation.c_assess_national_code,
                        evaluation.c_assess_post_code,
                        evaluation.c_assessor_national_code,
                        evaluation.c_assessor_post_code,
                        evaluation.evaluation_period_id,
                        evaluation.average_score,
                        evaluation.c_assessor_full_name,
                        evaluation.c_assess_full_name,
                        evaluation.status_catalog_id,
                        evaluation.ghesmat_title,
                        evaluation.moavenat_title,
                        evaluation.mojtama_title,
                        evaluation.omoor_title,
                        evaluation.post_title,
                        behavioral.avg_value,
                        behavioral.weight,
                        development.avg_value,
                        development.weight,
                        operational.avg_value,
                        operational.weight,
                        items.countItem
            ]]>
        </createView>
    </changeSet>
</databaseChangeLog>